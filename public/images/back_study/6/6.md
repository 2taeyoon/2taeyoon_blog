## 🦮 폼 → Ajax → API → DB

요즘은 AI에게 모든걸 맡기다 보니 점점 실력이 도태되고 있는 것 같은 느낌이 매우 들고 있던 시기입니다.
그래서 간단한 중복 체크 기능에 대해 초보자도 이해할 수 있을 정도로 자세히 적어보기로 했습니다.

회원 가입이나 회원 정보 수정 화면에서는 같은 전화번호를 다른 사람이 이미 쓰고 있는지 확인하는 기능이 거의 필수입니다.

이 글에서는 폼에서 사용자가 번호를 입력하고, 중복 체크 버튼을 누르면 페이지 새로고침 없이 서버에 요청이 가고, 서버(API·DB)에서 중복 여부를 판단한 뒤 다시 화면에 결과가 나오는 전체 흐름을 단계별로 정리합니다.

> 💡 **미리 알아두면 좋은 말들**  
> - **폼(form)** = 사용자가 입력하는 화면 (전화번호 칸, 버튼 등)  
> - **Ajax** = 페이지를 새로 고침하지 않고 서버에 요청을 보내는 방식  
> - **API** = 서버에서 “중복 체크해줘” 같은 요청을 받아서 처리하는 창구  
> - **DB** = 전화번호 같은 데이터가 저장되어 있는 데이터베이스  

구현 자체는 단순하지만, **화면(프론트)** 와 **서버**의 역할을 어떻게 나누느냐에 따라 나중에 수정하거나 기능을 붙이기 쉬워집니다.

---

## 🦮 전화번호 입력 폼 구조

전화번호를 한 칸이 아니라 `010-1234-5678` 처럼 3칸으로 나눠서 입력받도록 만들었습니다.

```html
<div class="form-label">
  <span class="required">*</span> 휴대폰 번호
</div>
<div class="form-field">
  <input type="tel" id="phone_1" class="input" /> -
  <input type="tel" id="phone_2" class="input" /> -
  <input type="tel" id="phone_3" class="input" />

  <input type="hidden" id="isPhoneChecked" value="" />
  <button type="button" id="btnCheckPhone">중복 체크</button>
</div>
```

### 🦄 코드가 하는 일 (쉽게 말하면)

- **phone_1, phone_2, phone_3**  
  사용자가 010, 1234, 5678 처럼 세 칸에 나눠 입력하는 입력 칸입니다.
- **isPhoneChecked (hidden)**  
  화면에는 안 보이지만, “중복 체크를 한 번이라도 했는지” 값을 저장해 두는 칸입니다.  
  나중에 “중복 체크를 안 했으면 가입 버튼 막기” 같은 걸 할 때 쓰입니다.
- **btnCheckPhone**  
  “중복 체크” 버튼입니다. 이걸 누르면 아래에서 설명하는 JavaScript가 실행됩니다.

### 🦄 3칸으로 나눈 이유

- 010-1234-5678 형태를 사용자에게 자연스럽게 안내할 수 있고
- “숫자만 입력하세요” 같은 검증을 하기 쉽고
- 서버로 보낼 때 하나의 문자열(예: `010-1234-5678`)로 통일하기 좋기 때문입니다.

---

## 🦮 중복 체크 버튼 클릭 시 JS 처리

중복 체크는 페이지를 새로 열지 않고, Ajax로 서버에 요청을 보냅니다.  
그래서 화면이 깜빡이지 않고 그 자리에서 결과만 바뀌게 됩니다.

```javascript
$('#btnCheckPhone').on('click', function () {
  const p1 = $('#phone_1').val();
  const p2 = $('#phone_2').val();
  const p3 = $('#phone_3').val();

  const userId = $('input[name="userId"]').val() || '';

  if (!p1 || !p2 || !p3) {
    alert('전화번호를 모두 입력해주세요.');
    return;
  }

  $.ajax({
    type: 'POST',
    url: '/api/user/check-phone',
    data: {
      phone: `${p1}-${p2}-${p3}`,
      userId: userId,
    },
    success: function (res) {
      if (res === 'OK') {
        alert('사용 가능한 전화번호입니다.');
        $('#isPhoneChecked').val('Y');
      } else {
        alert('이미 사용 중인 전화번호입니다.');
        $('#isPhoneChecked').val('N');
      }
    },
  });
});
```

### 🦄 한 줄씩 이해하기

1. **`$('#btnCheckPhone').on('click', ...)`**  
   “중복 체크” 버튼을 클릭했을 때 안에 있는 코드를 실행합니다.

2. **`p1, p2, p3`**  
   세 칸(010, 1234, 5678)에 입력된 값을 각각 가져옵니다.

3. **`userId`**  
   회원 수정 화면일 때 “지금 수정 중인 회원 번호”를 가져옵니다.  
   신규 가입 화면에서는 보통 비어 있습니다. (3번에서 다시 설명)

4. **`if (!p1 || !p2 || !p3)`**  
   세 칸 중 하나라도 비어 있으면 “전화번호를 모두 입력해주세요.” 알림을 띄우고,  
   서버에는 요청을 보내지 않고 여기서 멈춥니다.

5. **`$.ajax({ ... })`**  
   페이지 새로고침 없이 서버의 `/api/user/check-phone` 주소로  
   `phone`(합친 전화번호), `userId`를 보냅니다.

6. **`success: function (res)`**  
   서버에서 보낸 결과(res) 를 받습니다.  
   - `res === 'OK'` → “사용 가능” → `isPhoneChecked`에 `Y` 저장  
   - 그 외(예: `DUPLICATED`) → “이미 사용 중” → `isPhoneChecked`에 `N` 저장  

### 🦄 JS(화면 쪽)가 하는 일 정리

- 세 칸 값을 모아서 하나의 전화번호 문자열로 만든다.
- 빈 칸이 있으면 요청을 보내지 않는다.
- 서버 결과를 그대로 믿고, 알림 메시지와 hidden 값만 바꾼다.  
  → “이 번호가 진짜 중복인지” 같은 판단은 전부 서버가 합니다.

> 👉 프론트는 판단하지 않는다  
> “사용 가능 / 이미 사용 중” 같은 결정은 서버만 하고,  
> 화면(JS)은 그 결과를 받아서 메시지와 상태만 바꿔 줍니다.

---

## 🦮 userId를 함께 넘기는 이유

```javascript
const userId = $('input[name="userId"]').val() || '';
```

이 값은 회원 정보 수정 화면을 생각했을 때 필요합니다.

- **신규 가입**  
  `userId`가 없음 → “이 전화번호를 쓰는 회원이 한 명이라도 있나?” 로 전체 대상 중복 체크.
- **정보 수정**  
  `userId`가 있음 → “이 전화번호를 쓰는 회원이 나 말고 다른 사람으로 있나?” 로,  
  자기 자신은 제외하고 중복 체크.

이렇게 신규 / 수정을 나누는 처리는 `서버(API·DB)` 쪽에서 합니다.  
화면은 그냥 `userId`가 있으면 넘기고, 없으면 빈 값으로 넘기면 됩니다.

---

## 🦮 API 컨트롤러 처리

API는 “중복 체크해줘” 요청을 받는 서버의 창구입니다.  
여기서 하는 일은 딱 세 가지입니다.

1. 화면에서 넘긴 값(전화번호, userId) 받기  
2. 모델(DB 조회 담당) 부르기  
3. 모델 결과에 따라 OK / DUPLICATED 같은 문자열만 돌려주기  

“실제로 DB에서 어떻게 찾을지” 같은 비즈니스 로직은 컨트롤러에 넣지 않고, 모델에 맡깁니다.

```php
public function checkPhone()
{
    $params = $this->getParams();
    $exists = $this->userModel->isPhoneExists($params);

    if ($exists) {
        echo 'DUPLICATED';
    } else {
        echo 'OK';
    }
}
```

### 🦄 읽는 방법

- **getParams()**  
  화면에서 보낸 `phone`, `userId` 등을 모아 둔 것이라고 보면 됩니다.
- **isPhoneExists($params)**  
  “이 전화번호가 이미 DB에 있는지” 확인하는 모델 함수입니다.  
  있으면 true, 없으면 false를 돌려줍니다.
- **echo 'DUPLICATED' / 'OK'**  
  그 결과를 문자열로 그대로 화면에 돌려줍니다.  
  그래서 화면(JS)에서는 `res === 'OK'` 같은 단순한 비교만 하면 됩니다.

---

## 🦮 모델에서 실제 중복 여부 판단

모델은 DB에 직접 조회해서 “이 전화번호가 이미 있나?”를 판단하는 부분입니다.

```php
public function isPhoneExists($params)
{
    $phone = trim($params['phone']);
    $exclude = '';

    if (!empty($params['userId'])) {
        $exclude = " AND id != '{$params['userId']}'";
    }

    $sql = "
        SELECT id
        FROM users
        WHERE phone = '{$phone}'
          AND is_deleted = 0
          {$exclude}
        LIMIT 1
    ";

    return $this->db->fetchOne($sql);
}
```

### 🦄 쿼리가 하는 일 (쉽게 말하면)

- **users** 테이블에서  
  “전화번호가 지금 입력한 `$phone`과 같은 행이 있는지” 찾습니다.
- **is_deleted = 0**  
  “삭제 처리된 회원”은 제외합니다. (실제로 쓰는 회원만 봅니다.)
- **$exclude (id != userId)**  
  수정 화면일 때만 들어갑니다.  
  “나 자신(id = userId)은 제외하고, 다른 사람 중에 같은 번호가 있는지” 보는 겁니다.

### 🦄 반환값이 의미하는 것

- **결과가 한 건이라도 있으면**  
  → 이미 그 전화번호를 쓰는 회원이 있다 → 중복(사용 불가)  
- **결과가 없으면**  
  → 그 번호를 쓰는 사람이 없다 → 사용 가능

---

## 🦮 전체 흐름 요약 (처음부터 끝까지)

1. 사용자가 전화번호 3칸에 입력하고 중복 체크 버튼을 누른다.
2. JS가 세 칸 값을 모아서 하나의 전화번호로 만들고, 빈 칸이 없으면 `Ajax`로 서버에 보낸다.
3. 서버 `API(컨트롤러)` 가 요청을 받고, 모델을 호출한다.
4. 모델이 DB에서 “이 전화번호 + (수정이면 본인 제외)” 조건으로 조회한다.
5. 모델이 결과(있음/없음)를 컨트롤러에 돌려주고, 컨트롤러는 OK 또는 DUPLICATED 를 화면에 돌려준다.
6. 화면(JS)은 그 결과에 맞게 알림 메시지와 `isPhoneChecked` 값을 바꾼다.

---

## 🦮 이 구조의 장점

- **페이지 이동 없음** → 화면이 깜빡이지 않아서 사용성이 좋다.
- **화면 / 서버 역할이 나뉘어 있어서**  
  “중복 기준을 바꾸고 싶다”면 서버만, “버튼 문구만 바꾸고 싶다”면 화면만 수정하면 된다.
- **신규 가입 / 정보 수정** 둘 다 같은 API를 쓰기 때문에 코드가 반복되지 않는다.
- 나중에 `REST API`, `JSON` 형태로 바꿔도 구조를 크게 바꾸지 않고 확장하기 쉽다.

---

## 🦮 마무리

전화번호 중복 체크는 자주 만나는 기능이지만,  
`“화면 → 서버 → DB”` 흐름을 한 번 정리해 두면 비슷한 기능(이메일 중복, 닉네임 중복 등)을 만들 때도 똑같이 적용할 수 있습니다.

이번에 정리한 구조는

- 불필요한 로직 중복이 없고
- 각 단계(폼 → API → 모델 → DB) 구분이 분명해서  
  나중에 “SMS 인증 넣기”, “중복 체크 안 했으면 가입 막기” 같은 기능을 붙이기 좋습니다.