## ğŸ¦®GEMO í”„ë¡œì íŠ¸ API ì„¤ì •ê³¼ ì—°ê²°

> ì´ë²ˆ í”„ë¡œì íŠ¸ëŠ” GEMOë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì§„í–‰í•˜ëŠ” ê°„ë‹¨í•œ ì›¹ê²Œì„ ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤. ì²« ë‹¨ê³„ë¡œ ì›Œë“¤ ê²Œì„ì„ êµ¬í˜„í–ˆìœ¼ë©°, ì´ë¥¼ ìœ„í•´ ì‚¬ìš©ëœ API ì„¤ì •ê³¼ ê´€ë ¨ëœ ë¶€ë¶„ì„ ì •ë¦¬í•´ ë³´ë ¤ê³  í•©ë‹ˆë‹¤.

---

### ğŸ¦„ Repo ê°œìš”Â·ëª©í‘œ
- í”„ë¡ íŠ¸: gemo-frontend â€” Next.js(App Router) + **NextAuth(êµ¬ê¸€ OAuth)** + **MongoDB** ê²Œì„ìš© ìœ ì € ìƒíƒœ/í†µê³„ APIë¥¼ **Route Handlers**ë¡œ ì§ì ‘ ì œê³µí•©ë‹ˆë‹¤.
- ë°±ì—”ë“œ: gemo-backend â€” **Spring Boot** ì¥ê¸°ì ìœ¼ë¡œ ì¤‘ì•™ API/ì§‘ê³„/ì–´ë“œë¯¼ ì²˜ë¦¬ ì—­í• ì„ í•©ë‹ˆë‹¤.
- ëª©í‘œ: ë¡œê·¸ì¸ â†’ ì„¸ì…˜ â†’ ìœ ì € ì´ˆê¸°í™” â†’ ì¶œì„ â†’ ìŠ¹/íŒ¨ â†’ ì—°ìŠ¹ â†’ ë ˆë²¨/XP íë¦„ì„ ì¼ê´€ëœ ê·œì¹™ìœ¼ë¡œ ìœ ì§€í•˜ê³  ë¯¼ê° APIëŠ” ë³´í˜¸í•©ë‹ˆë‹¤.

---

## ğŸ¦® ì¸ì¦Â·ì„¸ì…˜: NextAuth + Google OAuth + JWT

### ğŸ¦„ í•µì‹¬ ê²°ì •
- **ì„¸ì…˜ ì „ëµ: JWT**: ì„œë²„ ìƒíƒœë¥¼ ì•ˆ ë“¤ê³  ê°€ì„œ ê°€ë³ê³  API ë¼ìš°íŠ¸ ì–´ë””ì„œë“  `getServerSession`ìœ¼ë¡œ ì‹ë³„ ë
**MongoDBAdapter ë¯¸ì‚¬ìš©**. ì´ìœ :
  **ìŠ¤í‚¤ë§ˆ ë³€ë™ ì¦ìŒ**: ê²Œì„ í†µê³„ í•„ë“œ ê³„ì† ëŠ˜ì–´ë‚  ìˆ˜ ìˆìŒ.  
  **ë§ˆì´ê·¸ë ˆì´ì…˜**: insert/updateë¥¼ ì½”ë“œë¡œ ì§ì ‘ ì»¨íŠ¸ë¡¤í•´ì•¼ ë””ë²„ê¹…Â·ë§ˆì´ê·¸ë ˆì´ì…˜ì´ í¸í•¨
# ğŸ¦„ NextAuth ì„¤ì • ìš”ì§€
rc/app/api/auth/[...nextauth]/route.ts`
```typescript
import NextAuth from 'next-auth'
import GoogleProvider from 'next-auth/providers/google'
import clientPromise from '@/lib/mongodb'

const handler = NextAuth({
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID || '',
      clientSecret: process.env.GOOGLE_CLIENT_SECRET || '',
    }),
  ],
  secret: process.env.NEXTAUTH_SECRET,
  session: { strategy: 'jwt' },
  pages: { signIn: '/login' },
  callbacks: {
    async jwt({ token, user }) {
      // ìµœì´ˆ ë¡œê·¸ì¸ ì‹œì ì—ë§Œ user ì¡´ì¬ â†’ ê·¸ë•Œ token.userId ì„¤ì •
      if (user) token.userId = user.id
      return token
    },
    async session({ session, token }) {
      // ì„œë²„/í´ë¼ ëª¨ë‘ì—ì„œ session.user.idë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ ë™ê¸°í™”
      if (token?.userId && session.user) (session.user as any).id = token.userId
      return session
    },
    async signIn({ user }) {
      // ìµœì´ˆ ë¡œê·¸ì¸ ì‹œ ìœ ì € ë¬¸ì„œ ì»¤ìŠ¤í…€ ì´ˆê¸°í™”
      const client = await clientPromise
      const db = client.db('gemo')
      const users = db.collection('users')

      const existing = await users.findOne({ email: user.email })
      if (existing) { user.id = existing._id.toString(); return true }

      const newUser = {
        name: user.name,
        email: user.email,
        image: user.image,
        emailVerified: null,
        createdAt: new Date(),
        updatedAt: new Date(),
        gameData: {
          level: 1,
          currentXp: 0,
          totalXp: 0,
          totalScore: 0,
          kodleGameWins: 0,
          kodleGameDefeat: 0,
          kodleSuccessiveVictory: 0,
          kodleMaximumSuccessiveVictory: 0,
          achievements: [],
          lastPlayed: null,
          lastAttendance: null,
          consecutiveAttendance: 0,
        },
        thema: 'light',
        notifications: true,
      }
      const res = await users.insertOne(newUser)
      user.id = res.insertedId.toString()
      return true
    },
  },
})

export { handler as GET, handler as POST }
```
- ì´ ì½”ë“œëŠ” **êµ¬ê¸€ ë¡œê·¸ì¸ ì—°ê²°**, **JWT ì„¸ì…˜ ìš´ìš©**, **ìµœì´ˆ ë¡œê·¸ì¸ ì‹œ ìœ ì € ì´ˆê¸°í™”**ê¹Œì§€ ë‹´ë‹¹í•©ë‹ˆë‹¤.
ì„ íƒ ì´ìœ : ìœ ì € ì´ˆê¸° ìƒíƒœë¶€í„° ê²Œì„ í†µê³„ êµ¬ì¡°ê¹Œì§€ í•œ ë²ˆì— ì¡ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ¦® MongoDB ì—°ê²° íŒ¨í„´

### ğŸ¦„ ì „ì—­ Promiseë¡œ ì¤‘ë³µ ì—°ê²° ë°©ì§€
```typescript
// src/lib/mongodb.ts
import { MongoClient } from 'mongodb'

const uri = process.env.MONGODB_URI!
const client = new MongoClient(uri)
let clientPromise = client.connect()

export default clientPromise
```
ì´ìœ : ì„œë²„ë¦¬ìŠ¤/ê°œë°œ í™˜ê²½ì—ì„œ **ë§¤ ìš”ì²­ ì—°ê²° ìƒì„±**ì„ í”¼í•©ë‹ˆë‹¤. ë¹Œë“œÂ·ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì»¤ë„¥ì…˜ í­ì¦ ë°©ì§€.

---

## ğŸ¦® ê³µí†µ ê°€ë“œ: getServerSession ì‚¬ìš© íŒ¨í„´

### ğŸ¦„ ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ ì¸ì¦ í•„ìˆ˜
```typescript
import { getServerSession } from 'next-auth'
import { authOptions } from '@/app/api/auth/[...nextauth]/route'

export async function GET(req: Request) {
  const session = await getServerSession(authOptions)
  if (!session?.user) {
    return Response.json({ error: 'ë¡œê·¸ì¸ í•„ìš”' }, { status: 401 })
  }
  const userId = (session.user as any).id
  // userId ê¸°ì¤€ìœ¼ë¡œ DB ì ‘ê·¼
}
```
ì´ìœ : ëª¨ë“  APIì—ì„œ ì¸ì¦ ëˆ„ë½ì„ ë§‰ê³ , ì²˜ë¦¬ íë¦„ì„ í†µì¼í•©ë‹ˆë‹¤.

---

## ğŸ¦® /api/user ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì„¤ê³„

### ğŸ¦„ ê³µí†µ ê·œì¹™
- ì¸ì¦ í•„ìˆ˜ `getServerSession`
- `ObjectId.isValid` ì²´í¬ë¡œ ì˜ëª»ëœ ID ìš”ì²­ ë°©ì–´.
- ë‹¨ìˆœ ì¹´ìš´íŒ…ì€ `$inc`, ë³µí•© ê³„ì‚°ì€ ì½”ë“œì—ì„œ ê³„ì‚° í›„ **ì •í™•í•œ `$set`**.
- ì‘ë‹µ ìŠ¤í‚¤ë§ˆ í†µì¼: `{ success, data?, error?, code? }`.

### ğŸ¦„ í”„ë¡œí•„
**GET** `/api/user/profile` â€” ë¡œê·¸ì¸ ì‚¬ìš©ìì˜ ì „ì²´ í”„ë¡œí•„ ë°˜í™˜
**PUT** `/api/user/profile` â€” ë¶€ë¶„ ì—…ë°ì´íŠ¸ `updatedAt`ëŠ” ì„œë²„ì—ì„œ ê°±ì‹ 

```typescript
// GET
const doc = await users.findOne({ _id: new ObjectId(userId) })
if (!doc) return NextResponse.json({ error: 'í”„ë¡œí•„ ì—†ìŒ' }, { status: 404 })
return NextResponse.json({ success: true, data: doc })

// PUT
const body = await req.json()
await users.updateOne(
  { _id: new ObjectId(userId) },
  { $set: { ...body, updatedAt: new Date() } },
)
return NextResponse.json({ success: true })
```
: ì „ì²´ ë®ì–´ì“°ê¸°ë³´ë‹¤ ì•ˆì „í•˜ê³  ë³€ê²½ ì´ë ¥ ì¶”ì ì´ ì‰¬ì›€

### ğŸ¦„ ì¶œì„(Attendance)
**POST** `/api/user/attendance` â€” ì˜¤ëŠ˜ ì¶œì„ ì²˜ë¦¬. `KST ê¸°ì¤€`ìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€.  
**GET** `/api/user/attendance` â€” ì˜¤ëŠ˜ ì¶œì„ ì—¬ë¶€/ì—°ì†ì¼ìˆ˜/ìµœê·¼ ë‚ ì§œ ë°˜í™˜.

`ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´(KST, YYYY-MM-DD)`
```typescript
const today = new Date()
  .toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul' })
  .replace(/\. /g, '-').replace('.', '').replace(/\s/g, '')

```
#### ë¡œì§ ê°œìš”
* lastAttendance === today â†’ 400 (ì´ë¯¸ ì¶œì„)
* ì–´ì œì™€ ì—°ì†ì´ë©´ consecutiveAttendance + 1, ì•„ë‹ˆë©´ 1ë¡œ ì´ˆê¸°í™”
* ì¶œì„ ë³´ìƒ XP â†’ totalXp ë°˜ì˜ â†’ level/currentXp ì¬ê³„ì‚°
* lastAttendance = today ì €ì¥

ì´ìœ : ì„œë¹„ìŠ¤ ê¸°ì¤€ ì‹œê°„ì„ KSTë¡œ ê³ ì •í•´ì„œ â€œì˜¤ëŠ˜â€ ì •ì˜ë¥¼ ì¼ê´€ë˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤.

### ğŸ¦„ ìŠ¹/íŒ¨Â·ì—°ìŠ¹(KODLE)
**POST** `/api/user/kodle-game-win` â€” ìŠ¹ë¦¬ ì²˜ë¦¬: `wins++`, `successive++`, `maxSuccessive` ê°±ì‹ , **ìŠ¹ë¦¬ ë³´ìƒ XP ì§€ê¸‰**
**GET** `/api/user/kodle-game-win` â€” ìŠ¹ë¦¬/ì—°ìŠ¹/ìµœë‹¤ì—°ìŠ¹ ì¡°íšŒ(êµ¬ í•„ë“œëª… í•˜ìœ„í˜¸í™˜ í¬í•¨ ê°€ëŠ¥)
**GET** `/api/user/kodle-game-defeat` â€” íŒ¨ë°°/ì—°ìŠ¹ í˜„í™© ì¡°íšŒ
**POST** `/api/user/reset-win-streak` â€” ì—°ìŠ¹ ì´ˆê¸°í™”, `defeat++`

#### ìŠ¹ë¦¬ ì²˜ë¦¬ ê°œìš”
* í˜„ì¬ wins/successive/max ê°’ ì½ê¸°
* wins += 1; successive += 1; max = max(max, successive)
* ìŠ¹ë¦¬ ë³´ìƒ XP ì§€ê¸‰ â†’ totalXp ì—…ë°ì´íŠ¸ â†’ level/currentXp ì¬ê³„ì‚°
* $set ì €ì¥(í•„ìš” í•„ë“œë§Œ ì •í™•íˆ)

ì´ìœ : í†µê³„Â·ë ˆë²¨ì´ ì–½í˜€ ìˆì–´ **ì›ìì„±ê³¼ ì¼ê´€ì„±**ì„ ë³´ì¥í•´ì•¼ í•¨.

---

## ğŸ¦® ë ˆë²¨Â·XP ê³„ì‚° ê·œì¹™

### ğŸ¦„ ë³´ì¡° í•¨ìˆ˜(ì˜ˆì‹œ)
```typescript
function getRequiredXpForLevel(level: number) {
  return level < 10 ? 100 : level < 20 ? 150 : 200
}
function calculateLevelFromTotalXp(totalXp: number) {
  let level = 1, remaining = totalXp
  while (remaining >= getRequiredXpForLevel(level)) {
    remaining -= getRequiredXpForLevel(level)
    level++
  }
  return { level, currentXp: remaining }
}
```
ì´ìœ : `totalXp` ê¸°ì¤€ìœ¼ë¡œ ì—­ì‚°í•˜ë©´ ë ˆë²¨ í…Œì´ë¸”ì„ ë°”ê¿”ë„ ëŒ€ì‘ì´ ì‰½ìŠµë‹ˆë‹¤.

---

## ğŸ¦® ê¶Œí•œ(RBAC): superAdmin ê²Œì´íŠ¸

### ğŸ¦„ í† í°Â·ì„¸ì…˜ ë™ê¸°í™”
```typescript
// jwt ì½œë°±
if (user) {
  token.userId = user.id
  token.superAdmin = (user as any).superAdmin ?? false
}
// session ì½œë°±
if (session.user) {
  (session.user as any).id = token.userId
  ;(session.user as any).superAdmin = token.superAdmin
}
```
### ğŸ¦„ ë¼ìš°íŠ¸ ë³´í˜¸ íŒ¨í„´
```typescript
const s = await getServerSession(authOptions)
if (!s?.user) return NextResponse.json({ error: 'ë¡œê·¸ì¸ í•„ìš”' }, { status: 401 })
if (!(s.user as any).superAdmin) {
  // ë¯¼ê° ë¦¬ì†ŒìŠ¤ ì€ë‹‰
  return NextResponse.json({ error: 'Not Found' }, { status: 404 })
  // ë˜ëŠ” App Router not-foundë¡œ rewrite
}
```
ì´ìœ : ë¯¼ê° APIëŠ” **ì¡´ì¬ ìì²´ë¥¼ ìˆ¨ê¸°ëŠ” ê²Œ** ë” ì•ˆì „í•œ ê²½ìš°ê°€ ë§ì•„ë³´ì˜€ë‹¤.

---

## ğŸ¦® í”„ë¡ íŠ¸ UI í¬ì¸íŠ¸

### ğŸ¦„ ë¡œê·¸ì¸ í˜ì´ì§€
```tsx
// src/app/auth/Auth.tsx
"use client"
import { signIn, getProviders } from 'next-auth/react'
import { useEffect, useState } from 'react'

export default function AuthPage() {
  const [providers, setProviders] = useState<any>(null)
  const [loading, setLoading] = useState(false)

  useEffect(() => { getProviders().then(setProviders) }, [])

  return (
    <main>
      <h1>ë¡œê·¸ì¸</h1>
      {providers && Object.values(providers).map((p: any) => (
        <button
          key={p.id}
          disabled={loading}
          onClick={async () => { setLoading(true); await signIn(p.id, { callbackUrl: '/' }); setLoading(false) }}
        >
          {loading ? 'ì§„í–‰ ì¤‘...' : `${p.name}ë¡œ ì‹œì‘í•˜ê¸°`}
        </button>
      ))}
    </main>
  )
}
```
ì´ìœ : í”„ë¡œë°”ì´ë” ëª©ë¡ì„ ëŸ°íƒ€ì„ì— ë°›ì•„ ë²„íŠ¼ ìë™í™” â†’ ì„¤ì • ë³€ê²½ ì‹œ UI ìˆ˜ì • ìµœì†Œí™”

### ğŸ¦„ ë³´í˜¸ëœ í™”ë©´ì—ì„œ ì„¸ì…˜ ì‚¬ìš©
```tsx
import { useSession } from 'next-auth/react'

const { data: session, status } = useSession()
if (status === 'loading') return <Spinner />
if (!session?.user) return <LoginRequired />

return <Dashboard userId={(session.user as any).id} />
```
ì´ìœ : í´ë¼ì—ì„œë„ ì ‘ê·¼ ì œì–´ë¥¼ ì´ì¤‘í™”í•©ë‹ˆë‹¤(ì„œë²„ ê°€ë“œ + í´ë¼ ê°€ë“œ)

---

## ğŸ¦® ì—ëŸ¬Â·ìš´ì˜Â·ì„±ëŠ¥

### ğŸ¦„ ì—ëŸ¬ í¬ë§·
- í†µì¼: `{ success: false, error: 'MESSAGE', code: 'E_SOMETHING', details?: any }`
- 401/403/404/409/422/429/500 êµ¬ë¶„ ëª…í™•íˆ, í´ë¼ì—ì„œ ë¶„ê¸° ì²˜ë¦¬ ì‰¬ì›Œì§.

### ğŸ¦„ ì¸ë±ìŠ¤
- `users.email`, `users._id` ê¸°ë³¸.
- ì¡°íšŒ ë§ì€ `gameData.*` í•„ë“œ(ì˜ˆ: ìŠ¹/íŒ¨/ì—°ìŠ¹ ëŒ€ì‹œë³´ë“œ) í•„ìš” ì‹œ ë³´ì¡° ì¸ë±ìŠ¤

### ğŸ¦„ ì¤‘ë³µ í˜¸ì¶œ
- ì¶œì„/ìŠ¹ë¦¬ APIëŠ” **ê°™ì€ ì…ë ¥ ë°˜ë³µ í˜¸ì¶œ**ì„ ë°©ì§€(ë²„íŠ¼ ë¹„í™œì„±, ì„œë²„ì¸¡ ì¬ì§„ì… ë°©ì§€)
- ìì • ì „í›„ ê²½ê³„ì—ì„œ ì¶œì„ ë‘ ë²ˆ ì°íˆëŠ” ì¼€ì´ìŠ¤ ë°©ì–´

### ğŸ¦„ ë¡œê·¸
- userId, ì•¡ì…˜, ë³€ê²½ëŸ‰(+XP, winsâ†’successive ë“±) ê¸°ë¡. PII ì£¼ì˜.


## ğŸ¦® ë§ˆë¬´ë¦¬
ì •ë¦¬í•˜ë©´, GEMO í”„ë¡œì íŠ¸ì˜ API ì„¤ê³„ëŠ” ë¡œê·¸ì¸ â†’ ì„¸ì…˜ ê´€ë¦¬ â†’ ìœ ì € ë°ì´í„° ì´ˆê¸°í™” â†’ ì¶œì„/ìŠ¹íŒ¨/ë ˆë²¨ ì—… ì²˜ë¦¬ê¹Œì§€ íë¦„ì„ í•˜ë‚˜ì˜ ê·œì¹™ìœ¼ë¡œ ì¼ê´€ë˜ê²Œ ê´€ë¦¬í•˜ëŠ” ë° ì´ˆì ì„ ë§ì·„ìŠµë‹ˆë‹¤.

NextAuthì™€ JWTë¥¼ í™œìš©í•´ ì¸ì¦ì„ ê°€ë³ê²Œ ì²˜ë¦¬í•˜ë©´ì„œë„, MongoDBì— ì§ì ‘ ì ‘ê·¼í•´ ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆë¥¼ ìœ ì—°í•˜ê²Œ ìš´ì˜í•  ìˆ˜ ìˆê²Œ êµ¬ì„±í–ˆê³ , ê° APIëŠ” getServerSession ê¸°ë°˜ ê°€ë“œë¥¼ í†µí•´ ë³´ì•ˆì„±ì„ í™•ë³´í–ˆìŠµë‹ˆë‹¤.

ì´ êµ¬ì¡°ëŠ” ë‹¨ìˆœí•œ ì›Œë“¤ ê²Œì„ ì´ìƒì˜ í™•ì¥ì„ ê³ ë ¤í•œ ì„¤ê³„ì´ì, ì•ìœ¼ë¡œ ë‹¤ì–‘í•œ ê²Œì„ ëª¨ë“ˆê³¼ í†µê³„ ì§‘ê³„ ê¸°ëŠ¥ì„ ë¶™ì´ë”ë¼ë„ ì•ˆì •ì ìœ¼ë¡œ ë™ì‘í•  ìˆ˜ ìˆëŠ” ê¸°ë°˜ì´ ë  ê²ƒì…ë‹ˆë‹¤. ã…ã… ğŸ¤¤ğŸ¤¤